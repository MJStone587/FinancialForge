<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/stylesheets/style.css" />
    <link
    rel="icon"
    type="image/x-icon"
    href="/images/favicon_io/favicon.ico"
  />
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Summary</title>
  </head>

  <% if(authCheck){ %> 
    <%- include("navbarLI") %> 
    <% } else { %> 
    <%-include("navbar") %> 
   <% } %>

  <!-- Summary Header -->
  
  <div class="summary_header">
    <h1><%= authUser %>'s <%= title %></h1>
    <p>View all income, expenses and spending habits</p>
    <img src="/images/summary.png" alt="Summary Image" />
  </div>

  <div class="summary_charts">
      <button id="exp_btn">Expenses</button>
      <button id="inc_btn">Income</button>
    <div class="chartDisp1">
      <h1>Monthly Spending</h1>
      <canvas id="monthlySpending"></canvas>
    </div>
    <div class="chartDisp2">
      <h1>Major Expenses</h1>
      <canvas id="majorExpenses"></canvas>
    </div>
    <div class="chartDisp3">
      <h1>Monthly Income</h1>
      <canvas id="monthlyIncome"></canvas>
    </div>
    <div class="chartDisp4">
      <h1>Income Sources</h1>
      <canvas id="incomeSources"></canvas>
    </div>
  </div>

  <div class="summary_body">
    <!-- Summary Income List-->
    <% let total_income = 0; %> <% let balance = 0 %>
    <h1 class="summary_incomeTitle">Income</h1>
    <a href="/catalog/income/create"id="addIncome">+</a>
    <div class="summary_incomeList">
      <h3>Name</h3>
      <h3>Description</h3>
      <h3>Total</h3>
      <h3>Date</h3>
      <h3>Details</h3>
      <% for(let i = 0; i < incomes.length; i++){ %>
      <p id="summary_iName"><%= incomes[i].name %></p>
      <p id="summary_iDesc"><%= incomes[i].description %></p>
      <p id="summary_iAmt">$<%= incomes[i].amount %></p>
      <p id="summary_iDate"><%= incomes[i].date_month %></p>
      <a id="summary_iDet" href="/catalog/income/<%= incomes[i]._id %>">More</a>
      <% total_income += incomes[i].amount %> <% } %> 
      <% function round(value,decimals) { %> 
      <% return Number(Math.round(value +'e'+decimals) +'e-'+ decimals).toFixed(decimals); %> 
      <% } %>
    </div>
    <h2 class="summary_incomeTotal">
      Income Total: $<%= round(total_income,2) %>
    </h2>

    <!--       Summary Receipts                -->
    <h1 class="summary_receiptTitle">Expenses</h1>
    <a href="/catalog/receipt/create" id="addExpense">+</a>
    <div class="summary_receiptList">
      <h3>Name</h3>
      <h3>Total</h3>
      <h3>Date</h3>
      <h3>Details</h3>
      <% for(let i = 0; i < receipts.length; i++) { %>
      <p id="summary_recName"><%= receipts[i].name %></p>
      <p><%= "$" + receipts[i].total %></p>
      <p><%= receipts[i].date_month %></p>
      <a href="/catalog/receipt/<%= receipts[i]._id %>">More</a>
      <% } %>
    </div>
    <% var monthRecTotals = [0,0,0,0,0,0,0,0,0,0,0,0] %>
    <% var months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"] %>
    <% var total_receipt = 0; %> 
    <% var categories = ["Food","Entertainment","House","Car","Work","Clothing","Pet","Self-Care"]%>
    <% var catTotals = [0,0,0,0,0,0,0,0] %>
    <% for(let i = 0; i < receipts.length; i++) { %> 
      <% total_receipt += receipts[i].total; %> 
      <% } %>
     <% function round(value, decimals) { %> 
      <% return Number(Math.round(value +'e'+ decimals) +'e-'+ decimals).toFixed(decimals); %> 
      <% } %>

    <% for(let i=0; i< receipts.length; i++) { %>
         <% for(let x=0; x< months.length; x++){ %>
           <% if(receipts[i].date_month == months[x]) { %>
              <% monthRecTotals[x] += receipts[i].total; %>
            <% } %>
           <% } %>
       <% } %>

    <% for(let i=0; i< receipts.length; i++) { %>
        <% for(let x=0; x< categories.length; x++){ %>
          <% if(receipts[i].category == categories[x]) { %>
             <% catTotals[x] += 1; %>
           <% } %>
          <% } %>
      <% } %>
    
    <h2 class="summary_receiptTotal">
      Receipt Totals: $<%=round(total_receipt, 2);%>
    </h2>
  </div>
  <!--  Balance and Charts -->
  <% balance = total_income - total_receipt %>
  <h1 class="summary_balance">Balance = $<%= round(balance, 2); %></h1>
  <script>
    const ctx = document.getElementById("monthlySpending");
    const gtx = document.getElementById("majorExpenses");
    const mtx = document.getElementById("monthlyIncome");
    const btx = document.getElementById("incomeSources");
    const expBtn = document.getElementById("exp_btn");
    const incBtn = document.getElementById("inc_btn");
    const chart1 = document.querySelector(".chartDisp1");
    const chart2 = document.querySelector(".chartDisp2");
    const chart3 = document.querySelector(".chartDisp3");
    const chart4 = document.querySelector(".chartDisp4");

    expBtn.addEventListener("click", function() {
      expBtn.style.backgroundColor = "white";
      incBtn.style.backgroundColor = "#4edff991";
      chart1.style.display = "grid";
      chart2.style.display = "grid";
      chart3.style.display = "none";
      chart4.style.display = "none";

    })
    incBtn.addEventListener("click", function() {
      incBtn.style.backgroundColor = "white"
      expBtn.style.backgroundColor = "#4edff991";
      chart1.style.display = "none";
      chart2.style.display = "none";
      chart3.style.display = "grid";
      chart4.style.display = "grid";
    })

    var myChart = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: ["Jan", "Feb", "March","Apr","May","June", "July", "Aug", "Sept", "Oct", "Nov", "Dec"],
        datasets: [{
            label: "Spending in Dollars",
            data: ["<%=monthRecTotals[0]%>", "<%=monthRecTotals[1]%>", "<%=monthRecTotals[2]%>", "<%=monthRecTotals[3]%>", "<%=monthRecTotals[4]%>", "<%=monthRecTotals[5]%>","<%=monthRecTotals[6]%>", "<%=monthRecTotals[7]%>", "<%=monthRecTotals[8]%>", "<%=monthRecTotals[9]%>", "<%=monthRecTotals[10]%>", "<%=monthRecTotals[11]%>"],
            backgroundColor: [
                'rgba(255, 99, 132, 0.2)',
                'rgba(54, 162, 235, 0.2)',
                'rgba(255, 206, 86, 0.2)',
                'rgba(75, 192, 192, 0.2)',
                'rgba(153, 102, 255, 0.2)',
                'rgba(255, 159, 64, 0.2)'
            ],
            borderColor: [
                'rgba(255,99,132,1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)'
            ],
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        yAxes: {
                  beginAtZero:true
            }
    }
});
var newChart = new Chart(gtx, {
    type: 'pie',
    data: {
        labels: ["Food","Entertainment","House","Car","Work","Clothing","Pet","Self-Care"],
        datasets: [{
            label: "Major Expenses",
            data: ["<%=catTotals[0] %>", "<%=catTotals[1] %>", "<%=catTotals[2] %>", "<%=catTotals[3] %>", "<%=catTotals[4] %>", "<%=catTotals[5] %>", "<%=catTotals[6] %>", "<%=catTotals[7] %>"],
            backgroundColor: [
                'rgba(255, 99, 132, 0.2)',
                'rgba(54, 162, 235, 0.2)',
                'rgba(255, 206, 86, 0.2)',
                'rgba(75, 192, 192, 0.2)',
                'rgba(153, 102, 255, 0.2)',
                'rgba(255, 159, 64, 0.2)',
                'rgba(236, 255, 3, 0.2)',
                'rgba(98, 79, 15, 0.2)'

            ],
            borderColor: [
                'rgba(255,99,132,1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)',
                'rgba(236, 255, 3, 1)',
                'rgba(98, 79, 15, 1)'
            ],
            borderWidth: 1
        }]
    },
    options: {
      responsive: true,
    }
});
var myChart = new Chart(mtx, {
    type: 'bar',
    data: {
        labels: ["Jan", "Feb", "March","Apr","May","June", "July", "Aug", "Sept", "Oct", "Nov", "Dec"],
        datasets: [{
            label: "Spending in Dollars",
            data: [900, 500, 300, 1000, 400, 334, 412, 321, 823, 304, 458, 499],
            backgroundColor: [
                'rgba(255, 99, 132, 0.2)',
                'rgba(54, 162, 235, 0.2)',
                'rgba(255, 206, 86, 0.2)',
                'rgba(75, 192, 192, 0.2)',
                'rgba(153, 102, 255, 0.2)',
                'rgba(255, 159, 64, 0.2)'
            ],
            borderColor: [
                'rgba(255,99,132,1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)'
            ],
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        yAxes: {
                  beginAtZero:true
            }
    }
});
var newChart = new Chart(btx, {
    type: 'pie',
    data: {
        labels: ["Gas", "Food", "Entertainment"],
        datasets: [{
            label: "Major Expenses",
            data: [6, 12, 23  ],
            backgroundColor: [
                'rgba(255, 99, 132, 0.2)',
                'rgba(54, 162, 235, 0.2)',
                'rgba(255, 206, 86, 0.2)',
                'rgba(75, 192, 192, 0.2)',
                'rgba(153, 102, 255, 0.2)',
                'rgba(255, 159, 64, 0.2)'
            ],
            borderColor: [
                'rgba(255,99,132,1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)'
            ],
            borderWidth: 1
        }]
    },
    options: {
      responsive: true,
    }
});
  </script>
  <%- include('footer') %>
</html>
